const findEl=(id,memoryItemClass)=>void 0===memoryItemClass?"string"==typeof id?document.getElementById(id):id:findEl("memory-container--"+id).querySelector("."+memoryItemClass),fadeOut=(el,duration=250,callback=()=>{})=>{(el=findEl(el)).style.transition=duration+"ms",el.style.opacity=0,setTimeout(()=>{el.style.display="none",callback()},duration)},fadeIn=(el,display="block",duration=250,callback=()=>{})=>{(el=findEl(el)).style.opacity=0,"none"===el.style.display&&(el.style.display=display),setTimeout(()=>{el.style.transition=duration+"ms",el.style.opacity=1,setTimeout(()=>{callback()},duration)},0)},val=(el,value)=>{if(el instanceof HTMLInputElement&&"checkbox"===el.type){if(void 0===value)return el.checked;el.checked=value}if("string"==typeof el&&(el=findEl(el)),void 0===value)return el?el.value:"";el&&(el.value=value)},showId=(id,display="block")=>{let el=findEl(id);el&&(el.style.display=display)},hideId=id=>{el=findEl(id),el&&(el.style.display="none")},setTextId=(id,text)=>{let el=findEl(id);el&&(el.innerText=text)},setHTML=(el,html)=>{(el="string"==typeof el?findEl(el):el)&&(el.innerHTML=html)},dispatch=(el,event)=>{if("string"==typeof el&&(el=findEl(el)),"string"==typeof event){if("focus"===event)return void el.focus();if("blur"===event)return void el.blur();event=new Event(event)}el&&el.dispatchEvent(event)},hasClass=(elOrId,className)=>{let el;if(el="string"==typeof elOrId?findEl(elOrId):elOrId,el)return el.classList.contains(className)},addClass=(elOrId,className)=>{let el;el="string"==typeof elOrId?findEl(elOrId):elOrId,el&&el.classList.add(className)},removeClass=(elOrId,className)=>{let el;el="string"==typeof elOrId?findEl(elOrId):elOrId,el&&el.classList.remove(className)},addListener=(el,event,listener)=>{(el="string"==typeof el?findEl(el):el)&&el.addEventListener(event,listener)},setPlaceholder=(el,text)=>{(el="string"==typeof el?findEl(el):el)&&void 0!==el.placeholder&&(el.placeholder=text)},style=(el,key,value)=>{if(el="string"==typeof el?findEl(el):el){if(void 0===value)return el.style[key];el.style[key]=value}},disable=(el,isDisabled=!0)=>{(el="string"==typeof el?findEl(el):el)&&(el.disabled=isDisabled)},slideUp=(el,duration=250,complete=()=>{})=>{(el="string"==typeof el?findEl(el):el)&&(el.style.transitionProperty="height, margin, padding",el.style.transitionDuration=duration+"ms",el.style.height=el.offsetHeight+"px",el.offsetHeight,el.style.overflow="hidden",el.style.height=0,el.style.paddingTop=0,el.style.paddingBottom=0,el.style.marginTop=0,el.style.marginBottom=0,window.setTimeout(()=>{el.style.display="none",el.style.removeProperty("height"),el.style.removeProperty("padding-top"),el.style.removeProperty("padding-bottom"),el.style.removeProperty("margin-top"),el.style.removeProperty("margin-bottom"),el.style.removeProperty("overflow"),el.style.removeProperty("transition-duration"),el.style.removeProperty("transition-property"),el.style.removeProperty("box-sizing"),complete()},duration))},slideDown=(el,duration=500,complete=()=>{})=>{if(el="string"==typeof el?findEl(el):el){el.style.removeProperty("display");let display=window.getComputedStyle(el).display;"none"===display&&(display="block"),el.style.display=display;var height=el.offsetHeight;el.style.overflow="hidden",el.style.height=0,el.style.paddingTop=0,el.style.paddingBottom=0,el.style.marginTop=0,el.style.marginBottom=0,el.offsetHeight,el.style.transitionProperty="height, margin, padding",el.style.transitionDuration=duration+"ms",el.style.height=height+"px",el.style.removeProperty("padding-top"),el.style.removeProperty("padding-bottom"),el.style.removeProperty("margin-top"),el.style.removeProperty("margin-bottom"),window.setTimeout(()=>{el.style.removeProperty("height"),el.style.removeProperty("overflow"),el.style.removeProperty("transition-duration"),el.style.removeProperty("transition-property"),complete()},duration)}},slideToggle=(el,duration=500,complete=()=>{})=>("none"===window.getComputedStyle(el).display?slideDown:slideUp)(el,duration,complete);var global={};function _min(d0,d1,d2,bx,ay){return d0<d1||d2<d1?d2<d0?d2+1:d0+1:bx===ay?d1:d1+1}"undefined"!=typeof window&&(global=window),global.state={dataVersion:0,memoryIsOpen:!1,menuIsOpen:!1,papers:{},papersList:[],paperTags:new Set,pdfTitleFn:null,showFavorites:!1,sortedPapers:[],sortKey:"",papersReady:!1},global.descendingSortKeys=["addDate","count","lastOpenDate","favoriteDate"],global.select2Options={placeholder:"Tag paper",maximumSelectionLength:5,allowClear:!0,tags:!0,tokenSeparators:[","," "]},global.menuCheckNames=["checkBib","checkMd","checkDownload","checkPdfTitle","checkFeedback","checkDarkMode","checkDirectOpen"],global.menuCheckDefaultFalse=["checkDarkMode","checkDirectOpen"],global.menuStorageKeys=[...global.menuCheckNames,"pdfTitleFn"],global.knownPaperPages={arxiv:["arxiv.org/abs/","arxiv.org/pdf/"],neurips:["neurips.cc/paper/","nips.cc/paper/"],cvf:["openaccess.thecvf.com/content"],openreview:["openreview.net/forum","openreview.net/pdf"],biorxiv:["biorxiv.org/content"],pmlr:["proceedings.mlr.press/"]},global.overrideORConfs={"robot-learning":"CoRL",ijcai:"IJCAI"},global.overridePMLRConfs={"Conference on Learning Theory":"CoLT","International Conference on Machine Learning":"ICML","Conference on Uncertainty in Artificial Intelligence":"UAI","Conference on Robot Learning":"CoRL","International Conference on Artificial Intelligence and Statistics":"AISTATS","International Conference on Algorithmic Learning Theory":"ALT"},global.fuzzyTitleMatchMinDist=4,global.englishStopWords=new Set([["i","me","my","myself","we","our","ours","ourselves","you","your","yours","yourself","yourselves","he","him","his","himself","she","her","hers","herself","it","its","itself","they","them","their","theirs","themselves","what","which","who","whom","this","that","these","those","am","is","are","was","were","be","been","being","have","has","had","having","do","does","did","doing","a","an","the","and","but","if","or","because","as","until","while","of","at","by","for","with","about","against","between","into","through","during","before","after","above","below","to","from","up","down","in","out","on","off","over","under","again","further","then","once","here","there","when","where","why","how","all","any","both","each","few","more","most","other","some","such","no","nor","not","only","own","same","so","than","too","very","s","t","can","will","just","don","should","now"]]);const levenshtein=(a,b)=>{if(a===b)return 0;var tmp;a.length>b.length&&(tmp=a,a=b,b=tmp);for(var la=a.length,lb=b.length;0<la&&a.charCodeAt(la-1)===b.charCodeAt(lb-1);)la--,lb--;for(var offset=0;offset<la&&a.charCodeAt(offset)===b.charCodeAt(offset);)offset++;if(lb-=offset,0===(la-=offset)||lb<3)return lb;for(var d0,d1,d2,d3,dd,dy,ay,bx0,bx1,bx2,bx3,x=0,vector=[],y=0;y<la;y++)vector.push(y+1),vector.push(a.charCodeAt(offset+y));for(var len=vector.length-1;x<lb-3;)for(bx0=b.charCodeAt(offset+(d0=x)),bx1=b.charCodeAt(offset+(d1=x+1)),bx2=b.charCodeAt(offset+(d2=x+2)),bx3=b.charCodeAt(offset+(d3=x+3)),dd=x+=4,y=0;y<len;y+=2)d0=_min(dy=vector[y],d0,d1,bx0,ay=vector[y+1]),d1=_min(d0,d1,d2,bx1,ay),d2=_min(d1,d2,d3,bx2,ay),dd=_min(d2,d3,dd,bx3,ay),vector[y]=dd,d3=d2,d2=d1,d1=d0,d0=dy;for(;x<lb;)for(bx0=b.charCodeAt(offset+(d0=x)),dd=++x,y=0;y<len;y+=2)dy=vector[y],vector[y]=dd=_min(dy,d0,dd,bx0,vector[y+1]),d0=dy;return dd};$.easing.jswing=$.easing.swing,$.extend($.easing,{def:"easeOutQuad",swing:(x,t,b,c,d)=>$.easing[$.easing.def](x,t,b,c,d),easeInQuad:(x,t,b,c,d)=>c*(t/=d)*t+b,easeOutQuad:(x,t,b,c,d)=>-c*(t/=d)*(t-2)+b,easeInOutQuad:(x,t,b,c,d)=>(t/=d/2)<1?c/2*t*t+b:-c/2*(--t*(t-2)-1)+b,easeInCubic:(x,t,b,c,d)=>c*(t/=d)*t*t+b,easeOutCubic:(x,t,b,c,d)=>c*((t=t/d-1)*t*t+1)+b,easeInOutCubic:(x,t,b,c,d)=>(t/=d/2)<1?c/2*t*t*t+b:c/2*((t-=2)*t*t+2)+b,easeInQuart:(x,t,b,c,d)=>c*(t/=d)*t*t*t+b,easeOutQuart:(x,t,b,c,d)=>-c*((t=t/d-1)*t*t*t-1)+b,easeInOutQuart:(x,t,b,c,d)=>(t/=d/2)<1?c/2*t*t*t*t+b:-c/2*((t-=2)*t*t*t-2)+b,easeInQuint:(x,t,b,c,d)=>c*(t/=d)*t*t*t*t+b,easeOutQuint:(x,t,b,c,d)=>c*((t=t/d-1)*t*t*t*t+1)+b,easeInOutQuint:(x,t,b,c,d)=>(t/=d/2)<1?c/2*t*t*t*t*t+b:c/2*((t-=2)*t*t*t*t+2)+b,easeInSine:(x,t,b,c,d)=>-c*Math.cos(t/d*(Math.PI/2))+c+b,easeOutSine:(x,t,b,c,d)=>c*Math.sin(t/d*(Math.PI/2))+b,easeInOutSine:(x,t,b,c,d)=>-c/2*(Math.cos(Math.PI*t/d)-1)+b,easeInExpo:(x,t,b,c,d)=>0==t?b:c*Math.pow(2,10*(t/d-1))+b,easeOutExpo:(x,t,b,c,d)=>t==d?b+c:c*(1-Math.pow(2,-10*t/d))+b,easeInOutExpo:(x,t,b,c,d)=>0==t?b:t==d?b+c:(t/=d/2)<1?c/2*Math.pow(2,10*(t-1))+b:c/2*(2-Math.pow(2,-10*--t))+b,easeInCirc:(x,t,b,c,d)=>-c*(Math.sqrt(1-(t/=d)*t)-1)+b,easeOutCirc:(x,t,b,c,d)=>c*Math.sqrt(1-(t=t/d-1)*t)+b,easeInOutCirc:(x,t,b,c,d)=>(t/=d/2)<1?-c/2*(Math.sqrt(1-t*t)-1)+b:c/2*(Math.sqrt(1-(t-=2)*t)+1)+b,easeInElastic:(x,t,b,c,d)=>{var s=1.70158,p=0,a=c;return 0==t?b:1==(t/=d)?b+c:(p=p||.3*d,s=a<Math.abs(c)?(a=c,p/4):p/(2*Math.PI)*Math.asin(c/a),-(a*Math.pow(2,10*--t)*Math.sin((t*d-s)*(2*Math.PI)/p))+b)},easeOutElastic:(x,t,b,c,d)=>{var s=1.70158,p=0,a=c;return 0==t?b:1==(t/=d)?b+c:(p=p||.3*d,s=a<Math.abs(c)?(a=c,p/4):p/(2*Math.PI)*Math.asin(c/a),a*Math.pow(2,-10*t)*Math.sin((t*d-s)*(2*Math.PI)/p)+c+b)},easeInOutElastic:(x,t,b,c,d)=>{var s=1.70158,p=0,a=c;return 0==t?b:2==(t/=d/2)?b+c:(p=p||d*(.3*1.5),s=a<Math.abs(c)?(a=c,p/4):p/(2*Math.PI)*Math.asin(c/a),t<1?a*Math.pow(2,10*--t)*Math.sin((t*d-s)*(2*Math.PI)/p)*-.5+b:a*Math.pow(2,-10*--t)*Math.sin((t*d-s)*(2*Math.PI)/p)*.5+c+b)},easeInBack:(x,t,b,c,d,s)=>c*(t/=d)*t*(((s=null==s?1.70158:s)+1)*t-s)+b,easeOutBack:(x,t,b,c,d,s)=>c*((t=t/d-1)*t*(((s=null==s?1.70158:s)+1)*t+s)+1)+b,easeInOutBack:(x,t,b,c,d,s)=>(null==s&&(s=1.70158),(t/=d/2)<1?c/2*(t*t*((1+(s*=1.525))*t-s))+b:c/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+b),easeInBounce:(x,t,b,c,d)=>c-$.easing.easeOutBounce(x,d-t,0,c,d)+b,easeOutBounce:(x,t,b,c,d)=>(t/=d)<1/2.75?c*(7.5625*t*t)+b:t<2/2.75?c*(7.5625*(t-=1.5/2.75)*t+.75)+b:t<2.5/2.75?c*(7.5625*(t-=2.25/2.75)*t+.9375)+b:c*(7.5625*(t-=2.625/2.75)*t+.984375)+b,easeInOutBounce:(x,t,b,c,d)=>t<d/2?.5*$.easing.easeInBounce(x,2*t,0,c,d)+b:.5*$.easing.easeOutBounce(x,2*t-d,0,c,d)+.5*c+b});const info=(...args)=>{console.log("%c[PM] "+args.join(" "),"color: #328DD2")},getDisplayId=id=>id=(id=id.split("_")[0].split(".")[0]).startsWith("OR-")?id:id.split("-").slice(0,2).join("-"),defaultPDFTitleFn=(title,id)=>(title=title.replaceAll("\n"," ").replace(/\s\s+/g," "))+` - ${id=id.split("_")[0].split(".")[0]}.pdf`,delay=(fn,ms)=>{let timer=0;return(...args)=>{clearTimeout(timer),timer=setTimeout(fn.bind(this,...args),ms||0)}},cleanPapers=papers=>{let cleaned={...papers};return delete cleaned.__dataVersion,cleaned},capitalize=s=>s.charAt(0).toUpperCase()+s.slice(1),firstNonStopLowercase=meaningful=>{let t=meaningful.toLowerCase(),words=t.split(" ").map(w=>w.replace(/[^0-9a-z]/gi,""));meaningful=words.filter(w=>global.englishStopWords.has(w));return(0<meaningful.length?meaningful:words)[0]},fallbackCopyTextToClipboard=text=>{var textArea=document.createElement("textarea");textArea.value=text,textArea.style.top="0",textArea.style.left="0",textArea.style.position="fixed",document.body.appendChild(textArea),textArea.focus(),textArea.select();try{var msg=document.execCommand("copy")?"successful":"unsuccessful";console.log("Fallback: Copying text command was "+msg)}catch(err){console.error("Fallback: Oops, unable to copy",err)}document.body.removeChild(textArea)},copyTextToClipboard=text=>{navigator.clipboard?navigator.clipboard.writeText(text).then(()=>{console.log("Async: Copying to clipboard was successful!")},err=>{console.error("Async: Could not copy text: ",err)}):fallbackCopyTextToClipboard(text)},parseUrl=url=>{var a=document.createElement("a");return a.href=url,a},downloadTextFile=(content,fileName,file)=>{var a=document.createElement("a");"text/plain"===file?(content=content.replace(/\\n/g,"%0D%0A").replace(/"/g,""),a.download=fileName,a.href="data:text/plain,"+content):(file=new Blob([content],{type:file}),a.href=URL.createObjectURL(file),a.download=fileName),a.click()},eventId=e=>e.target.closest(".memory-container").id.split("--")[1],downloadFile=(evt,fileName)=>{var save;window.ActiveXObject?window.ActiveXObject&&document.execCommand&&((save=window.open(evt,"_blank")).document.close(),save.document.execCommand("SaveAs",!0,fileName||evt),save.close()):((save=document.createElement("a")).href=evt,save.target="_blank",evt=evt.substring(evt.lastIndexOf("/")+1),save.download=fileName||evt,navigator.userAgent.toLowerCase().match(/(ipad|iphone|safari)/)&&navigator.userAgent.search("Chrome")<0?document.location=save.href:(evt=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}),save.dispatchEvent(evt),(window.URL||window.webkitURL).revokeObjectURL(save.href)))},getPdfFn=code=>{try{pdfTitleFn=eval(code)}catch(error){console.log("Error parsing pdf title function. Function string then error:"),console.log(code),console.log(error),pdfTitleFn=defaultPDFTitleFn}try{pdfTitleFn("test","1.2")}catch(error){console.log("Error testing the user's pdf title function. Function string then error:"),console.log(code),console.log(error),pdfTitleFn=defaultPDFTitleFn}return pdfTitleFn},migrateData=async(papers,manifestDataVersion,store=!0)=>{if(void 0===papers)return chrome.storage.local.set({papers:{__dataVersion:manifestDataVersion}}),{papers:{__dataVersion:manifestDataVersion},success:!0};var newId,newPaper,pdfVersion,currentVersion=papers.__dataVersion||-1,deleteIds=[];let newPapers={...papers};try{if(210===currentVersion)return{papers:papers,success:!0};store&&backupData({...papers}),delete papers.__dataVersion;for(const id in papers)currentVersion<5&&(info("Applying migration 5"),papers[id].hasOwnProperty("bibtex")||(papers[id].bibtex="",console.log("Migrating bibtex for "+id)),papers[id].pdfLink.endsWith(".pdf")||(papers[id].pdfLink=papers[id].pdfLink+".pdf"),papers[id].codeLink||(papers[id].codeLink=""),papers[id].source||(papers[id].id.includes("NeurIPS")?papers[id].source="neurips":papers[id].source="arxiv")),currentVersion<208&&(info("Applying migration 0.2.8"),"arxiv"!==papers[id].source&&papers[id].md.includes("https://arxiv.com/abs/")&&(papers[id].md=`[${papers[id].title}](${papers[id].pdfLink})`),"arxiv"!==papers[id].source&&papers[id].pdfLink.includes("arxiv.org/pdf/")&&(papers[id].source="arxiv"),id.match(/^\d/)&&"arxiv"===papers[id].source&&(newId="Arxiv-"+id,newPaper={...papers[id],id:newId},papers[newId]=newPaper,deleteIds.push(id))),currentVersion<209&&(info("Applying migration 0.2.9"),papers[id].hasOwnProperty("favorite")||(papers[id].favorite=!1,papers[id].favoriteDate="")),currentVersion<210&&(info("Applying migration 0.2.10"),"arxiv"!==papers[id].source||(pdfVersion=papers[id].pdfLink.match(/v\d+\.pdf/gi))&&0<pdfVersion.length&&(papers[id].pdfLink=papers[id].pdfLink.replace(pdfVersion[0],".pdf")),papers[id].hasOwnProperty("bibtext")&&(papers[id].bibtex=papers[id].bibtext+"",delete papers[id].bibtext));return deleteIds.forEach((id,k)=>{delete papers[id],console.log("Deleting "+id)}),newPapers={...papers},newPapers.__dataVersion=manifestDataVersion,store&&chrome.storage.local.set({papers:newPapers},()=>{console.log("Migrated papers:"),console.log(newPapers),console.log("Data version is now "+manifestDataVersion)}),{papers:newPapers,success:!0}}catch(err){return console.log(`Error migrating data from version ${currentVersion} to ${manifestDataVersion}:`),console.log(err),{papers:newPapers,success:!1,error:err}}},logStorage=key=>{chrome.storage.local.get(key,data=>{console.log(data[key])})},getStorage=async key=>new Promise((resolve,reject)=>{chrome.storage.local.get(key,data=>{resolve("string"==typeof key?data[key]:data)})}),setStorage=async(key,value)=>new Promise((resolve,reject)=>{chrome.storage.local.set({[key]:value},()=>{resolve(!0)})}),deletePaperInStorage=async id=>{const papers=await getStorage("papers");let deleted=!1;papers.hasOwnProperty(id)&&(deleted=delete papers[id]),deleted?(setStorage("papers",papers),console.log("Successfully deleted paper",id)):console.log("Error: no deletion")},getTheme=async()=>{return await getStorage("checkDarkMode")?"dark":"light"},backupData=async papers=>{chrome.storage.local.get("papersBackup",({papersBackup})=>{void 0===papersBackup&&(papersBackup={});for(const key of Object.keys(papersBackup).map(v=>parseInt(v)).sort((a,b)=>a<b?1:-1).slice(4))delete papersBackup[key];papersBackup[papers.__dataVersion]=papers,chrome.storage.local.set({papersBackup:papersBackup},()=>{console.log("Backed up data with version: "+papers.__dataVersion)})})},statePdfTitle=(title,id)=>{let name;try{name=global.state.pdfTitleFn(title,id)}catch(error){console.log("statePdfTitle error",error),name=defaultPDFTitleFn(title,id)}return name.replaceAll("\n"," ").replace(/\s\s+/g," ")},getManifestDataVersion=()=>{const manifest=chrome.runtime.getManifest();return manifest.version.split(".").map((v,k)=>parseInt(v)*10**(4-2*k)).reduce((a,b)=>a+b)},versionToSemantic=dataVersionInt=>(major=parseInt(dataVersionInt/1e4,10),dataVersionInt-=1e4*major,minor=parseInt(dataVersionInt/100,10),dataVersionInt-=100*minor,`${major}.${minor}.`+dataVersionInt),initState=async(papers,isContentScript)=>{var s=Date.now();void 0===papers&&(papers=await getStorage("papers"),console.log("Time to retrieve stored papers (s): "+(Date.now()-s)/1e3)),global.state.dataVersion=getManifestDataVersion(),global.state.pdfTitleFn=defaultPDFTitleFn;var m=Date.now(),migration=await migrateData(papers,global.state.dataVersion);console.log("Migration duration (s): "+(Date.now()-m)/1e3),papers=migration.papers,global.state.papers=papers,isContentScript||(global.state.papersList=Object.values(cleanPapers(papers)),global.state.sortKey="lastOpenDate",global.state.papersReady=!0,sortMemory(),makeTags()),console.log("State initialization duration (s): "+(Date.now()-s)/1e3)},hashCode=s=>s.split("").reduce((a,b)=>(a=(a<<5)-a+b.charCodeAt(0))&a,0),parseCVFUrl=id=>{const confAndYear=id.replace("https://openaccess.thecvf.com/content","").slice(1).split("/")[0].split("_");let conf,year;year=1===confAndYear.length?(conf=confAndYear[0].slice(0,-4),confAndYear[0].slice(-4)):(conf=confAndYear[0].toUpperCase(),confAndYear[1]);id=id.split("/").reverse()[0].split(".")[0],id=(hashCode(id)+"").replace("-","").slice(0,8),id=`${conf}-${year}_`+id;return{conf:conf,year:year,id:id}},isPaper=url=>{parseUrl(url);let is={};for(const source in global.knownPaperPages){var paths=global.knownPaperPages[source];is[source]=!1;for(const path of paths)url.includes(path)&&(is[source]=!0)}return is},cleanBiorxivURL=url=>url=(url=url.replace(".full.pdf","")).match(/\d$/)?url:url.split(".").slice(0,-1).join("."),parseIdFromUrl=url=>{var is=isPaper(url);if(is.arxiv)return"Arxiv-"+url.match(/\d{4}\.\d{4,5}/g)[0];if(is.neurips)return`NeurIPS-${url.split("/paper/")[1].split("/")[0]}_`+url.split("/").reverse()[0].split("-")[0].slice(0,8);if(is.cvf)return parseCVFUrl(url).id;if(is.openreview){const OR_id=url.match(/id=\w+/)[0].replace("id=","");var paper=Object.values(cleanPapers(global.state.papers)).filter(p=>p.id.includes(OR_id))[0];return paper&&paper.id}if(is.biorxiv){let id=(url=cleanBiorxivURL(url)).split("/").reverse()[0];return id.match(/v\d+$/)&&(id=id.split("v")[0]),"Biorxiv-"+id}if(is.pmlr){const key=url.split("/").reverse()[0].split(".")[0],year="20"+key.match(/\d+/)[0];return`PMLR-${year}-`+key}throw Error("unknown paper url")},paperToAbs=paper=>{const pdf=paper.pdfLink;let abs="";switch(paper.source){case"arxiv":abs="https://arxiv.org/abs/"+paper.id.split("-")[1];break;case"neurips":abs=pdf.replace("/file/","/hash/").replace("-Paper.pdf","-Abstract.html");break;case"cvf":abs=pdf.replace("/papers/","/html/").replace(".pdf",".html");break;case"openreview":abs=pdf.replace("/pdf?","/forum?");break;case"biorxiv":abs=pdf.replace(".full.pdf","");break;case"pmlr":abs=pdf.split("/").slice(0,-1).join("/")+".html";break;default:abs="https://xkcd.com/1969/"}return abs.replace("http://","https://")},paperToPDF=paper=>{let pdf=paper.pdfLink;switch(paper.source){case"arxiv":pdf=`https://arxiv.org/pdf/${paper.id.split("-")[1]}.pdf`;break;case"neurips":pdf=pdf.replace("/hash/","/file/").replace("-Abstract.html","-Paper.pdf");break;case"cvf":pdf=pdf.replace("/html/","/papers/").replace(".html",".pdf");break;case"openreview":pdf=pdf.replace("/forum?","/pdf?");break;case"biorxiv":pdf=cleanBiorxivURL(pdf)+".full.pdf";break;case"pmlr":break;default:pdf="https://xkcd.com/1969/"}return pdf.replace("http://","https://")},textareaFocusEnd=element=>{setTimeout(()=>{element.selectionStart=element.selectionEnd=1e4},0)},formatBibtext=commaMatches=>{let bib=commaMatches.trim().split("\n").join("").replace(/\s+=/g," =");var spaceMatches=bib.match(/\ \w+\ ?=\ ?{/g)||[],commaMatches=bib.match(/,\w+\ ?=\ ?{/g)||[];if(spaceMatches&&0<spaceMatches.length)for(const m of spaceMatches)bib=bib.replace(m,`
 `+m);if(commaMatches&&0<commaMatches.length)for(const m of commaMatches){var key=m.replace(",","");bib=bib.replace(m,`,
 `+key)}return"}}"===bib.slice(-2)&&(bib=bib.slice(0,-1)+"\n}"),bib.replaceAll("{ ","{").replaceAll(" }","}").replaceAll(" = ","=")},validatePaper=(paper,log=!0)=>{const expectedKeys={addDate:{type:"string",desc:"the paper's date of addition to the Memory",default:p=>(new Date).toJSON()},author:{type:"string",desc:"` and `-separated authors `${firstName} ${lastName}`"},bibtex:{type:"string",desc:"BibTex citation with new lines (`\n`)"},codeLink:{type:"string",desc:"the paper's code link",default:p=>""},count:{type:"number",desc:"the paper's number of visits",default:p=>1},favorite:{type:"boolean",desc:"user wants to star the paper",default:p=>!1},favoriteDate:{type:"string",desc:"date the paper was added as a favorite",default:p=>""},id:{type:"string",desc:"Unique PaperMemory ID"},key:{type:"string",desc:"BibTex citation key",default:p=>"defaultKey_"+p.id},lastOpenDate:{type:"string",desc:"When the paper was last opened",default:p=>(new Date).toJSON()},md:{type:"string",desc:"markdown-formatted string `[${title}](${pdfLink})`",default:p=>`[${p.title}](${p.pdfLink})`},note:{type:"string",desc:"the user's note for this paper",default:p=>""},pdfLink:{type:"string",desc:"the link to the paper's pdf"},source:{type:"string",desc:"the paper's source i.e. where it was added to the memory from"},tags:{type:"array[string]",desc:"the user's tags for this paper",default:p=>[]},year:{type:"string",desc:"year of publication"}};let warns=[];for(const key in expectedKeys)if(paper.hasOwnProperty(key)){const expectedType=expectedKeys[key].type;var defaultValue=typeof paper[key];if(expectedType.startsWith("array")){var subType=expectedType.split("[")[1].replace("]","");if(Array.isArray(paper[key])){if(0<paper[key].length){const keyType=typeof paper[key][0];keyType!==subType&&(message=`➤ ${key} should contain ${subType} not ${keyType} (${paper.id})`,warns.push(message),log&&console.warn(message))}}else message=`${key} should be an array (${paper.id})`,warns.push(message),log&&console.warn(message)}else defaultValue!==expectedType&&(message=`➤ ${key} should be of type ${expectedType} not ${defaultValue} (${paper.id})`,warns.push(message),log&&console.warn(message))}else{if(!expectedKeys[key].default)throw Error(`Cannot continue, paper is corrupted. Missing mandatory attribute "${key}" in `+paper.id);defaultValue=expectedKeys[key].default(paper);paper[key]=defaultValue,message=`➤ Attribute "${key}" absent; will be set to "${defaultValue}" (${paper.id})`,warns.push(message),log&&console.warn(message)}const sources=Object.keys(global.knownPaperPages);return sources.indexOf(paper.source)<0&&(message=`Unknown source ${paper.source} (${paper.id})`,warns.push(message),console.warn(message)),{warnings:warns,paper:paper}},tablerSvg=(pathName,id,classNames)=>{switch(id=(id=void 0===id?"":id)&&`id="${id}"`,classNames=(classNames=(classNames=void 0===classNames?[]:classNames).filter(c=>c))&&`class="${classNames.join(" ")}"`,pathName){case"adjustments":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="6" cy="10" r="2"/><line x1="6" y1="4" x2="6" y2="8"/><line x1="6" y1="12" x2="6" y2="20"/><circle cx="12" cy="16" r="2"/><line x1="12" y1="4" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="20"/><circle cx="18" cy="7" r="2"/><line x1="18" y1="4" x2="18" y2="5"/><line x1="18" y1="9" x2="18" y2="20"/></svg>`;case"circle-x":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><path d="M10 10l4 4m0 -4l-4 4"/></svg>`;case"star":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z"/></svg>`;case"writing":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 17v-12c0 -1.121 -.879 -2 -2 -2s-2 .879 -2 2v12l2 2l2 -2z"/><path d="M16 7h4"/><path d="M18 19h-13a2 2 0 1 1 0 -4h4a2 2 0 1 0 0 -4h-3"/></svg>`;case"file-symlink":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 21v-4a3 3 0 0 1 3 -3h5"/><path d="M9 17l3 -3l-3 -3"/><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M5 11v-6a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-9.5"/></svg>`;case"link":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5"/><path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5"/></svg>`;case"clipboard-list":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><line x1="9" y1="12" x2="9.01" y2="12"/><line x1="13" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="9.01" y2="16"/><line x1="13" y1="16" x2="15" y2="16"/></svg>`;case"archive":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10"/><line x1="10" y1="12" x2="14" y2="12"/></svg>`;case"external-link":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M11 7h-5a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-5"/><line x1="10" y1="14" x2="20" y2="4"/><polyline points="15 4 20 4 20 9"/></svg>`;case"file-download":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><polyline points="9 14 12 17 15 14"/></svg>`;case"cirlce-x":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><path d="M10 10l4 4m0 -4l-4 4"/></svg>`;case"settings":return`<svg viewBox="0 0 24 24" ${id} ${classNames}><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"/><circle cx="12" cy="12" r="3"/></svg>`;default:return""}},stringifyError=e=>{const extId=chrome.runtime.id;return e.stack.split("\n").map(line=>line.split(" ").map(word=>word.split(extId).reverse()[0]).join(" ")).join("<br/>")},overwriteMemory=async data=>{let error=!0,warning="",message="",papersToWrite;try{data.__dataVersion||(data.__dataVersion=1);var prevPapers,migration=await migrateData(data,getManifestDataVersion(),!1);if(!migration.success)return message="Could not migrate the data before storing it",migration.error&&(message+=":<br/>"+stringifyError(migration.error)),{success:!1,message:message};papersToWrite=migration.papers;for(const id in papersToWrite)id.startsWith("__")||(paperWarnings=validatePaper(papersToWrite[id]).warnings,paperWarnings&&0<paperWarnings.length&&(warning+="<br/>"+paperWarnings.join("<br/>")));warning&&(prevPapers=await getStorage("papers"),setStorage("uploadBackup",prevPapers)),error=!1}catch(err){console.log("overwriteMemory error",err),message='<h5 class="errorTitle">/!\\ OverwriteMemoryError:</h5><br>'+stringifyError(err),error=!0}return{success:!error,message:message,warning:warning,papersToWrite:papersToWrite}},arraysIdentical=(a,b)=>{var i=a.length;if(i!=b.length)return!1;for(;i--;)if(a[i]!==b[i])return!1;return!0},parseTags=el=>{let tags=Array.from(el.selectedOptions,e=>e.value.trim()).filter(e=>e);return tags.sort(),tags},getPaperEdits=(id,isPopup)=>{let note,tags,codeLink,favorite;return favorite=isPopup?(note=val("popup-form-note-textarea--"+id),codeLink=val(document.getElementById("popup-form-note--"+id).querySelector(".form-code-input")),tags=parseTags(findEl("popup-item-tags--"+id)),findEl("checkFavorite--"+id).checked):(note=val(findEl(id,"form-note-textarea")),codeLink=val(findEl(id,"form-code-input")),tags=parseTags(findEl(id,"memory-item-tags")),hasClass("memory-container--"+id,"favorite")),{note:note,tags:tags,codeLink:codeLink,favorite:favorite}},setFormChangeListener=(id,isPopup)=>{let refTags,refNote,refCodeLink,refFavorite;isPopup?(refTags="#popup-item-tags--"+id.replace(".","\\."),refCodeLink="popup-form-codeLink--"+id,refNote="popup-form-note-textarea--"+id,refFavorite="checkFavorite--"+id,$(refTags).on("change",monitorPaperEdits(id,isPopup)),addListener(refCodeLink,"keyup",monitorPaperEdits(id,isPopup)),addListener(refNote,"keyup",monitorPaperEdits(id,isPopup)),addListener(refFavorite,"change",monitorPaperEdits(id,isPopup))):(refTags=".memory-item-tags",refCodeLink=".form-code-input",refNote=".form-note-textarea",addEventToClass(refCodeLink,"keyup",monitorPaperEdits(id,isPopup)),addEventToClass(refNote,"keyup",monitorPaperEdits(id,isPopup)))},monitorPaperEdits=(id,isPopup)=>e=>{void 0===id&&(id=eventId(e));var edits=getPaperEdits(id,isPopup),paper=global.state.papers[id];let change=!1,refs={};for(const key in edits){var ref=paper[key];refs[key]=ref;var value=edits[key];("tags"===key&&!arraysIdentical(ref,value)||"tags"!==key&&ref!==value)&&(change=!0)}let btn;btn=isPopup?findEl("popup-save-edits--"+id):findEl(id,"memory-item-save-edits"),disable(btn,!change)},cutAuthors=(authArray,maxLen,separator)=>{void 0===maxLen&&(maxLen=140),void 0===separator&&(separator=", ");let cutAuthors="";var authArray=authArray.split(" and "),lastAuthor=authArray[authArray.length-1];for(const candidate of authArray){if(!(5+cutAuthors.length+separator.length+candidate.length+lastAuthor.length<maxLen)){cutAuthors+=" ... "+lastAuthor;break}cutAuthors?cutAuthors+=", "+candidate:cutAuthors=candidate}return cutAuthors},extractBibtexValue=(bibtex,regex2)=>{const regex=new RegExp(regex2+"\\s?=\\s?{(.+)},","gi");console.log(regex);const match=regex.exec(bibtex);if(match){regex2=new RegExp(regex2+"\\s?=\\s?{","gi");return match[0].replace(regex2,"").slice(0,-2)}return""},extractAuthor=bibtex=>extractBibtexValue(bibtex,"author").replaceAll("{","").replaceAll("}","").replaceAll("\\","").split(" and ").map(a=>a.split(", ").reverse().join(" ")).join(" and "),fetchArxivXML=async arxivId=>{arxivId=arxivId.replace("Arxiv-","");return $.get("https://export.arxiv.org/api/query",{id_list:arxivId})},fetchNeuripsHTML=async url=>{let paperPage;return paperPage=url.endsWith(".pdf")?url.replace("/file/","/hash/").replace("-Paper.pdf","-Abstract.html"):url,fetch(paperPage).then(response=>response.text())},fetchCvfHTML=async url=>{let paperPage,text;if(paperPage=url.endsWith(".pdf")?url.replace("/papers_backup/","/papers/").replace("/papers/","/html/").replace(".pdf",".html"):url,text=await fetch(paperPage).then(response=>response.ok?response.text():""),!text&&paperPage.includes("thecvf.com/content_")){const{conf,year}=parseCVFUrl(url);paperPage=paperPage.replace(`/content_${conf}_${year}/`,`/content_${conf.toLowerCase()}_${year}/`),text=await fetch(paperPage).then(response=>response.ok?response.text():"")}return text},fetchOpenReviewNoteJSON=async id=>{id=id.match(/id=\w+/)[0].replace("id=","");return fetch("https://api.openreview.net/notes?id="+id).then(response=>response.json())},fetchOpenReviewForumJSON=async id=>{id=id.match(/id=\w+/)[0].replace("id=","");return fetch("https://api.openreview.net/notes?forum="+id).then(response=>response.json())},parseArxivBibtex=async memoryId=>{let xmlData;xmlData="undefined"==typeof data?await fetchArxivXML(memoryId):data;var bibtex=$(xmlData),authors=[],key="";bibtex.find("author name").each((k,v)=>{authors.push($(v).text()),0===k&&(key+=$(v).text().split(" ")[$(v).text().split(" ").length-1].toLowerCase())});var pdfLink="";bibtex.find("link").each((k,v)=>{const link=$(v).attr("href");link&&0<=link.indexOf("arxiv.org/pdf/")&&(pdfLink=link)});var year=pdfLink.match(/v\d+\.pdf/gi);year&&0<year.length&&(pdfLink=pdfLink.replace(year[0],".pdf"));var author=authors.join(" and "),title=$(bibtex.find("entry title")[0]).text(),year=$(bibtex.find("entry published")[0]).text().slice(0,4);key+=year;bibtex="";return bibtex+=`@article{${key+=firstNonStopLowercase(title)},
`,bibtex+=`title={${title} },
`,bibtex+=`author={${author} },
`,bibtex+=`year={${year}},
`,bibtex+=`journal={arXiv preprint arXiv: ${memoryId}}
`,{author:author,bibtex:bibtex+="}",conf:"arXiv",id:memoryId,key:key,pdfLink:pdfLink,title:title,year:year}},parseNeuripsHTML=async url=>{const htmlText=await fetchNeuripsHTML(url);var note=(new DOMParser).parseFromString(htmlText.replaceAll("\n",""),"text/html");const doc=$(note);var bibtex=doc.find(".container-fluid .col p");const hash=url.split("/").slice(-1)[0].replace("-Paper.pdf","");var title=doc.find("h4").first().text(),author=$(bibtex[1]).text().split(", ").map((author,k)=>{const parts=author.split(" "),caps=parts.map((part,i)=>capitalize(part));return caps.join(" ")}).join(" and "),pdfLink=url,year=$(bibtex[0]).text().match(/\d{4}/)[0],key="neurips"+year+hash.slice(0,8),id=`NeurIPS-${year}_`+hash.slice(0,8),conf="NeurIPS "+year,note="Accepted @ "+conf,bibtex="";return bibtex+=`@inproceedings{NEURIPS${year}_${hash.slice(0,8)},
`,bibtex+=`author={${author}},
`,bibtex+=`booktitle={Advances in Neural Information Processing Systems},
`,bibtex+=`editor={H.Larochelle and M.Ranzato and R.Hadsell and M.F.Balcan and H.Lin},
`,bibtex+=`publisher={Curran Associates, Inc.},
`,bibtex+=`title={${title}},
`,bibtex+=`url={${url}},
`,bibtex+=`year={${year}}
`,{author:author,bibtex:bibtex+="}",conf:conf,id:id,key:key,note:note,pdfLink:pdfLink,title:title,year:year}},parseCvfHTML=async key=>{const htmlText=await fetchCvfHTML(key);var note=(new DOMParser).parseFromString(htmlText.replaceAll("\n",""),"text/html");const doc=$(note);var title=doc.find("#papertitle").text().trim();let author=doc.find("#authors i").first().text();author=author.split(",").map(a=>a.trim()).join(" and ");var{year,id,conf}=parseCVFUrl(key);let pdfLink="";key.endsWith(".pdf")?pdfLink=key:doc.find("a").each((k,v)=>{if("pdf"===$(v).text()){let href=$(v).attr("href");href.startsWith("../")&&(href=href.replaceAll("../","")),href.startsWith("/")||(href="/"+href),pdfLink="http://openaccess.thecvf.com"+href}});note=`Accepted @ ${conf} `+year;const bibtex=doc.find(".bibref").first().text();key=bibtex.split("{")[1].split(",")[0];return{author:author,bibtex:bibtex,conf:conf,id:id,key:key,note:note,pdfLink:pdfLink,title:title,year:year}};makeOpenReviewBibTex=(bibtex,url)=>{var title=bibtex.content.title,author=bibtex.content.authors.join(" and "),year=bibtex.cdate?new Date(bibtex.cdate).getFullYear():"0000";bibtex.cdate||console.log("makeOpenReviewBibTex: no cdate found in",bibtex);var key=bibtex.content.authors[0].split(" ").reverse()[0];key+=year;bibtex="";return bibtex+=`@inproceedings{${key+=firstNonStopLowercase(title)},
`,bibtex+=`title={${title}},
`,bibtex+=`author={${author}},
`,bibtex+=`year={${year}},
`,bibtex+=`url={${url}},
`,bibtex+="}"};const parseOpenReviewJSON=async conf=>{var key=await fetchOpenReviewNoteJSON(conf),year=await fetchOpenReviewForumJSON(conf),id=key.notes[0];console.log("paper: ",id);var forum=year.notes;console.log("forum: ",forum);var title=id.content.title,author=id.content.authors.join(" and ");const bibtex=id.content._bibtex||makeOpenReviewBibTex(id,conf);key=bibtex.split("{")[1].split(",")[0].trim(),year=bibtex.split("year={")[1].split("}")[0];let pdfLink;pdfLink=id.pdf?"https://openreview.net/pdf?id="+id.id:(id.html||conf).replace("/forum?id=","/pdf?id=");const confParts=id.invitation.split("/");let organizer=confParts[0].split(".")[0],event=confParts.slice(1).join("/").split("-")[0].replaceAll("/"," ").replace(" Conference",""),overrideOrg=organizer,overridden=!1;global.overrideORConfs.hasOwnProperty(organizer)&&(overrideOrg=global.overrideORConfs[organizer],overridden=!0),overridden&&(event=event.replace(overrideOrg,""),organizer=overrideOrg);conf=(organizer+" "+event).replace(/ \d\d\d\d/g,"").replace(/\s\s+/g," "),id=`OR-${organizer}-${year}_`+id.id;let candidates,decision,note;return candidates=forum.filter(r=>r&&r.content&&-1<["Final Decision","Paper Decision","Acceptance Decision"].indexOf(r.content.title)),console.log("forum: ",forum),candidates&&0<candidates.length&&(decision=candidates[0].content.decision.split(" ").map((v,i)=>0===i?v+"ed":v).join(" "),note=decision+` @ ${conf} `+year),"Anonymous"===author&&(note=`Under review @ ${conf} ${year} (${(new Date).toLocaleDateString()})`),{author:author,bibtex:bibtex,conf:conf,id:id,key:key,note:note,pdfLink:pdfLink,title:title,year:year}},parseBiorxivJSON=async year=>{var pdfLink=year.replace(".full.pdf",""),key="https://api.biorxiv.org//details/biorxiv/"+year.split("/").slice(-2).join("/").replace(".full.pdf","").split("v")[0];const data=await fetch(key).then(response=>response.json());if("ok"!==data.messages[0].status)throw new Error(key+" returned "+data.messages[0].status);const paper=data.collection.reverse()[0],pageData=await fetch(pdfLink),pageText=await pageData.text(),dom=(new DOMParser).parseFromString(pageText.replaceAll("\n",""),"text/html");var title=dom.querySelector(".bibtext a").href;const bibtex=await(await fetch(title)).text();var author=extractAuthor(bibtex),id=parseIdFromUrl(year),key=bibtex.split("\n")[0].split("{")[1].replace(",","").trim(),pdfLink=cleanBiorxivURL(year)+".full.pdf",title=paper.title,year=paper.date.split("-")[0];return{author:author,bibtex:bibtex,conf:"BioRxiv",id:id,key:key,note:"",pdfLink:pdfLink,title:title,year:year}},parsePMLRHTML=async title=>{var key=title.split("/").reverse()[0].split(".")[0],id=parseIdFromUrl(title);const absURL=title.includes(".html")?title:title.split("/").slice(0,-2).join("/")+(key+".html");var pdfLink=absURL.replace(".html","")+`/${key}.pdf`;const doc=(new DOMParser).parseFromString((await(await fetch(absURL)).text()).replaceAll("\n",""),"text/html");doc.getElementById("button-bibtex1").getAttribute("onclick").match(/https.+\.bib/)[0];const bibtexRaw=doc.getElementById("bibtex").innerText.replaceAll("\t"," ").replaceAll(/\s\s+/g," ");let bibtex=bibtexRaw;for(const item of bibtexRaw.match(/,\ ?\w+ ?= ?{/g))bibtex=bibtex.replace(item,item.replace(", ",",\n    ").replace(" = ","="));bibtex.endsWith("}}")&&(bibtex=bibtex.slice(0,-2)+"}\n}");var author=extractAuthor(bibtex),title=doc.getElementsByTagName("h1")[0].innerText,year=extractBibtexValue(bibtex,"year");let conf=extractBibtexValue(bibtex,"booktitle").replaceAll("Proceedings of the","");note="Accepted @ "+conf+`(${year})`;for(const long in global.overridePMLRConfs)if(conf.includes(long)){conf=global.overridePMLRConfs[long]+" "+year,note="Accepted @ "+conf;break}return{author:author,bibtex:bibtex,conf:conf,id:id,key:key,note:note,pdfLink:pdfLink,title:title,year:year}},fetchOpts={headers:{mode:"no-cors"}},fetchPWCId=async(arxiv_id,json)=>{let pwcPath="https://paperswithcode.com/api/v1/papers/?";arxiv_id?pwcPath+=new URLSearchParams({arxiv_id:arxiv_id}):json&&(pwcPath+=new URLSearchParams({title:json}));json=await $.getJSON(pwcPath);if(console.log({json:json}),1===json.count)return json.results[0].id},fetchCodes=async json=>{let arxiv_id,title;json.source="neurips",title=json.title;json=await fetchPWCId(arxiv_id,title);if(!json)return[];json=`https://paperswithcode.com/api/v1/papers/${json}/repositories/?`;json+=new URLSearchParams({page:1,items_per_page:10});const response=await fetch(json);json=await response.json();if(!(json.count<1)){let codes=json.results;return codes.sort((a,b)=>a.stars-b.stars),codes.slice(0,5)}},tryCrossRef=async paper=>{try{var api="https://api.crossref.org/works?rows=1&mailto=schmidtv%40mila.quebec&select=event%2Ctitle&query.title="+encodeURI(paper.title);const json=await fetch(api).then(response=>response.json());return"ok"!==json.status?(console.log(`[PM][Crossref] ${api} returned `+json.message.status),""):0===json.message.items.length||json.message.items[0].title[0].replaceAll("\n"," ").replaceAll(/\s\s+/g," ")!==paper.title.replaceAll("\n"," ").replaceAll(/\s\s+/g," ")?"":(info("Found a CrossRef match"),"[CrossRef]: Accepted @ "+json.message.items[0].event.name)}catch(error){return console.log("[PM][Crossref]",error),""}},initPaper=async paper=>{paper.note||(paper.note=await tryCrossRef(paper)),paper.md=`[${paper.title}](${paper.pdfLink})`,paper.tags=[],paper.codeLink="",paper.favorite=!1,paper.favoriteDate="",paper.addDate=(new Date).toJSON(),paper.lastOpenDate=paper.addDate,paper.count=1;for(const k in paper)paper.hasOwnProperty(k)&&"string"==typeof paper[k]&&(paper[k]=paper[k].trim());return validatePaper(paper),paper},makePaper=async(is,url,id)=>{let paper;if(is.arxiv)paper=await parseArxivBibtex(id),paper.source="arxiv";else if(is.neurips)paper=await parseNeuripsHTML(url),paper.source="neurips";else if(is.cvf)paper=await parseCvfHTML(url),paper.source="cvf";else if(is.openreview)paper=await parseOpenReviewJSON(url),paper.source="openreview";else if(is.biorxiv)paper=await parseBiorxivJSON(url),paper.source="biorxiv";else{if(!is.pmlr)throw Error("Unknown paper source: "+JSON.stringify({is:is,url:url,id:id}));paper=await parsePMLRHTML(url),paper.source="pmlr"}return initPaper(paper)},findFuzzyPaperMatch=paper=>{for(const paperId in global.state.papers)if("__dataVersion"!==paperId){var item=global.state.papers[paperId];if(Math.abs(item.title.length-paper.title.length)<global.fuzzyTitleMatchMinDist)if(levenshtein(item.title,paper.title)<global.fuzzyTitleMatchMinDist)return item.id}return null},addOrUpdatePaper=async(url,is,checks)=>{let paper,isNew;var id=parseIdFromUrl(url);return console.log("id: ",id),isNew=id&&global.state.papers.hasOwnProperty(id)?(global.state.papers=updatePaper(global.state.papers,id),paper=global.state.papers[id],!1):(paper=await makePaper(is,url,id),global.state.papers[paper.id]=paper,!0),chrome.storage.local.set({papers:global.state.papers},()=>{isNew?(console.log("Added '"+paper.title+"' to your Memory"),console.log("paper: ",paper),checks&&checks.checkFeedback&&feedback("Added to your Memory!",paper)):console.log("Updated '"+paper.title+"' in your Memory")}),{paper:paper,id:id}};