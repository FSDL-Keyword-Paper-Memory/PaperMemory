function delay(e,t){let o=0;return function(...s){clearTimeout(o),o=setTimeout(e.bind(this,...s),t||0)}}function fallbackCopyTextToClipboard(e){var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{var o=document.execCommand("copy"),s=o?"successful":"unsuccessful";console.log("Fallback: Copying text command was "+s)}catch(e){console.error("Fallback: Oops, unable to copy",e)}document.body.removeChild(t)}function copyTextToClipboard(e){navigator.clipboard?navigator.clipboard.writeText(e).then(function(){console.log("Async: Copying to clipboard was successful!")},function(e){console.error("Async: Could not copy text: ",e)}):fallbackCopyTextToClipboard(e)}function parseUrl(e){var t=document.createElement("a");return t.href=e,t}const downloadTextFile=(e,t,o)=>{var s=document.createElement("a"),n=new Blob([e],{type:o});s.href=URL.createObjectURL(n),s.download=t,s.click()};var state={menuIsOpen:!1,memoryIsOpen:!1,papers:{},papersList:[],sortedPapers:[],sortKey:"",paperTags:new Set};const arxiv=e=>{$.get("https://export.arxiv.org/api/query?id_list="+e).done(e=>{e=$(e);const t=e.find("entry title").text();let o=[];e.find("entry author name").each((e,t)=>o.push(t.textContent));const s=o[0].split(" ")[0]+year+t.split(" ")[0];o.join(" and "),year})},closeMenu=()=>{$("#menuDiv").slideUp({duration:500,easing:"easeOutQuint"})&&$("#tabler-menu").fadeOut(()=>{$("#tabler-menu").html('\n                <svg class="tabler-icon">\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-adjustments" />\n                </svg>\n            '),$("#tabler-menu").fadeIn()})},openMenu=()=>{$("#menuDiv").slideDown({duration:500,easing:"easeOutQuint"})&&$("#tabler-menu").fadeOut(()=>{$("#tabler-menu").html('\n        <svg class="tabler-icon menu-svg">\n            <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-circle-x" />\n        </svg>\n    '),$("#tabler-menu").fadeIn()})},focusExistingOrCreateNewTab=(e,t)=>{chrome.tabs.query({url:"https://arxiv.org/*"},o=>{let s=[],n=[];const a=o.map(e=>e.url);let r=0;for(const e of a)e.indexOf(t)>=0&&(s.push(r),e.indexOf(".pdf")>=0&&n.push(r)),r+=1;if(s.length>0){let e=0;e=n.length>0?o[n[0]].id:o[s[0]].id;var i={active:!0};chrome.tabs.update(e,i)}else chrome.tabs.create({url:e});state.papers[t].count+=1,chrome.storage.local.set({papers:state.papers})})},orderPapers=(e,t)=>{let o=e[state.sortKey],s=t[state.sortKey];return"string"==typeof o&&(o=o.toLowerCase(),s=s.toLowerCase()),["addDate","count","lastOpenDate"].indexOf(state.sortKey)>=0?o>s?-1:1:o>s?1:-1},sortMemory=()=>{state.sortedPapers=Object.values(state.papers),state.sortedPapers.sort(orderPapers),state.papersList.sort(orderPapers)},reverseMemory=()=>{state.sortedPapers.reverse(),state.papersList.reverse()},filterMemoryByString=e=>{const t=e.split(" ");let o=[];for(const e of state.sortedPapers){const s=e.title.toLowerCase(),n=e.author.toLowerCase();t.every(e=>s.includes(e)||n.includes(e))&&o.push(e)}state.papersList=o},filterMemoryByTags=e=>{const t=e.replace("t:","").toLowerCase().split(" ");let o=[];for(const e of state.sortedPapers){const s=e.tags.map(e=>e.toLowerCase());t.every(e=>s.some(t=>t.indexOf(e)>=0))&&o.push(e)}state.papersList=o},getTagsHTMLOptions=e=>{const t=state.papers[e],o=new Set(t.tags);return Array.from(state.paperTags).sort().map((e,t)=>{let s=`<option value="${e}"`;return o.has(e)&&(s+=' selected="selected" '),s+`>${e}</option>`}).join("")},getMemoryItemHTML=e=>{const t=new Date(e.addDate).toLocaleString().replace(",",""),o=new Date(e.lastOpenDate).toLocaleString().replace(",",""),s=e.arxivId.indexOf("_")<0?e.arxivId:e.arxivId.split("_")[0],n=e.note||"[no note]",a=e.arxivId,r=new Set(e.tags),i=getTagsHTMLOptions(a);return`\n    <div class="memory-item-container" tabindex="0" id="memory-item-container-${a}">\n\n        <h4 class="memory-item-title" title="Added ${t}&#13;&#10;Last open ${o}">\n            ${e.title}\n        </h4>\n        <div style="margin: 4px 0px;">\n            <small class="tag-list" id="tag-list--${a}">\n                ${Array.from(r).map(e=>`<span class="memory-tag">${e}</span>`).join("")}\n            </small>\n            <div id="edit-tags--${a}" style="padding: 12px 0px; display: none; ">\n                <div style="display:flex; align-items: center"; justify-content: space-between">\n                    <select id="memory-item-tags--${a}"class="memory-item-tags" multiple="multiple">\n                        ${i}\n                    </select>\n                    <button class="back-to-focus" style="margin-left: 12px" id="save-tag-edit--${a}">Done</button>\n                    <button class="back-to-focus" style="margin-left: 12px" id="cancel-tag-edit--${a}">Cancel</button>\n                </div>\n            </div>\n        </div>\n        <small>${e.author}</small>\n\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2px">\n\n        \n            <div style="display: flex; align-items: center">\n                <div\n                    class="memory-item-expand memory-item-svg-div"\n                    id="memory-item-expand--${a}"\n                    title="Expand paper details"\n                    style="margin-right: 3px"\n                >\n                    <svg  style="height: 15px; width: 15px; pointer-events: none;" >\n                        <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-arrows-vertical" />\n                    </svg>\n                </div>\n                <small>\n                    ${s}\n                </small>\n            </div>\n\n            <div\n                class="memory-item-tag memory-item-svg-div" \n                id="memory-item-tag--${a}"\n                title="Open ${e.pdfLink}" \n            >\n                <svg  style="height: 15px; width: 15px; pointer-events: none;" >\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-tag" />\n                </svg>\n            </div>\n            <div\n                class="memory-item-link memory-item-svg-div" \n                id="memory-item-link--${a}"\n                title="Open ${e.pdfLink}" \n            >\n                <svg  style="height: 15px; width: 15px; pointer-events: none;" >\n                   <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-external-link" />\n                </svg>\n            </div>\n                \n            <div \n                class="memory-item-copy-link memory-item-svg-div"\n                id="memory-item-copy-link--${a}"\n                title="Copy pdf link" \n            >\n                <svg style="height: 15px; width: 15px; pointer-events: none;" >\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-link" />\n                </svg>\n            </div>\n\n            <div \n                class="memory-item-md memory-item-svg-div"\n                id="memory-item-md--${a}"\n                title="Copy Markdown-formatted link" \n            >\n                <svg style="height: 15px; width: 15px; pointer-events: none;" >\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-clipboard-list" />\n                </svg>\n            </div>\n\n            <span style="color: green; display: none" id="memory-item-feedback--${a}"></span>\n            \n            <div title="Number of times you have loaded&#13;&#10;the paper's Page or PDF">\n                Visits: ${e.count}\n            </div>\n\n        </div>\n\n        <div id="extended-item--${a}" class="extended-item" style="display: none">\n            <div id="item-note--${a}">\n                <p style="font-size: 0.8rem;">\n                    <span id="note-content--${a}">${n}</span>\n                    <span id="edit-note-item--${a}" class="edit-note-item">(edit)</span>\n                </p>\n                <form class="form-note" id="form-note--${a}" style="display: none">\n                    <textarea style="width:98%" id="form-note-textarea--${a}">${n}</textarea>\n                    <div class="form-note-buttons">\n                        <button type="submit">Save</button>\n                        <button class="cancel-note-form back-to-focus" id="cancel-note-form--${a}">Cancel</button>\n                    </div>\n                </form>\n            </div>\n        </div>\n\n        <div class="delete-memory-item" id="delete-memory-item--${a}"> - </div>\n    </div>\n    `},displayMemoryTable=()=>{$("#memory-table").html("");for(const e of state.papersList)$("#memory-table").append(getMemoryItemHTML(e));$(".back-to-focus").click(e=>{const t=e.target.id.split("--").slice(-1)[0],o=t.replace(".","\\.");$(`#memory-item-container--${o}`).focus()}),$(".delete-memory-item").click(e=>{const t=e.target.id.split("--").slice(-1)[0];confirmDelete(t)}),$(".memory-item-link").click(e=>{const t=e.target.id.split("--").slice(-1)[0],o=state.papers[t].pdfLink;focusExistingOrCreateNewTab(o,t)}),$(".memory-item-md").click(e=>{const t=e.target.id.split("--").slice(-1)[0],o=state.papers[t].md;copyAndConfirmMemoryItem(t,o,"Markdown Link Copied!")}),$(".memory-item-copy-link").click(e=>{const t=e.target.id.split("--").slice(-1)[0],o=state.papers[t].pdfLink;copyAndConfirmMemoryItem(t,o,"Pdf Link Copied!")}),$(".memory-item-tag").click(e=>{const t=e.target.id.split("--").slice(-1)[0],o=t.replace(".","\\.");$(`#tag-list--${o}`).hide(),$(`#edit-tags--${o}`).show(),$(`#memory-item-tags--${o}`).select2({placeholder:"Tag paper...",maximumSelectionLength:5,allowClear:!0,tags:!0,width:"75%",tokenSeparators:[","," "]}),$(`#memory-item-tags--${o}`).focus(),$(`#save-tag-edit--${o}`).click(()=>{let e=[];$(`#memory-item-tags--${o}`).find(":selected").each((t,o)=>{const s=$.trim($(o).val());""!==s&&e.push(s)}),updatePaperTags(t,e),updatePaperTagsHTML(t),$(`#edit-tags--${o}`).hide(),$(`#tag-list--${o}`).show()}),$(`#cancel-tag-edit--${o}`).click(()=>{$(`#edit-tags--${o}`).hide(),$(`#tag-list--${o}`).show(),$(`#memory-item-tags--${o}`).html(getTagsHTMLOptions(t))})}),$(".form-note").submit(e=>{e.preventDefault();const t=e.target.id.split("--").slice(-1)[0],o=$(`#form-note-textarea-${t}`.replace(".","\\.")).val();saveNote(t,o)}),$(".edit-note-item").click(e=>{e.preventDefault();const t=e.target.id.split("--").slice(-1)[0];$(`#form-note-${t}`.replace(".","\\.")).fadeIn()}),$(".cancel-note-form").click(e=>{e.preventDefault();const t=e.target.id.split("--").slice(-1)[0];$(`#form-note-${t}`.replace(".","\\.")).hide()}),$(".memory-item-expand").click(e=>{e.preventDefault();const t=e.target.id.split("--").slice(-1)[0],o=t.replace(".","\\.");$(`#memory-item-expand--${o}`).hasClass("expand-open")?($(`#memory-item-expand--${o}`).removeClass("expand-open"),$(`#extended-item--${o}`).slideUp()):($(`#memory-item-expand--${o}`).addClass("expand-open"),$(`#extended-item--${o}`).slideDown())})},updatePaperTagsHTML=e=>{const t=e.replace(".","\\.");$(`#tag-list--${t}`).html(state.papers[e].tags.map(e=>`<span class="memory-tag">${e}</span>`).join(""))},updatePaperTags=(e,t)=>{t.sort(),updated=!1,state.papers[e].tags!==t&&(updated=!0),state.papers[e].tags=t,console.log("Update tags to: "+t.join(", ")),updated&&chrome.storage.local.set({papers:state.papers}),makeTags()},makeTags=()=>{let e=new Set;for(const t of state.sortedPapers)for(const o of t.tags)e.add(o);state.paperTags=Array.from(e),state.paperTags.sort()},saveNote=(e,t)=>{console.log(e,t),state.papers[e].note=t,chrome.storage.local.set({papers:state.papers},()=>{console.log("Updated the note for "+state.papers[e].title),$(`#form-note-${e}`.replace(".","\\.")).hide(),$(`#note-content-${e}`.replace(".","\\.")).text(t)})},copyAndConfirmMemoryItem=(e,t,o)=>{const s=`#memory-item-feedback-${e}`.replace(".","\\.");copyTextToClipboard(t),$(s).text(o),$(s).fadeIn(),setTimeout(()=>{$(s).text("")},1e3)},confirmDelete=e=>{const t=state.papers[e].title;$("body").append(`\n    <div style="width: 100%; height: 100%; background-color:  #e0e0e0; position: absolute; top: 0; left: 0; z-index: 100; display:  flex; justify-content:  center; align-items: center; flex-direction: column" id="confirm-modal">\n    \n    <div style="width: 80%; padding: 32px 32px; text-align: center; font-size: 1.1rem;">\n        Are you sure you want to delete:\n         <p>${t}</p>\n         ?\n    </div>\n    \n    <div style="width: 100%; text-align: center; padding: 32px;">\n        <button style="padding: 8px 16px;" id="cancel-modal-button">Cancel</button>\n        <span style="min-width: 32px;"></span>\n        <button style="padding: 8px 16px;" id="confirm-modal-button">Confirm</button>\n    </div>\n    \n    </div>\n    `),$("#cancel-modal-button").click(()=>{$("#confirm-modal").remove()}),$("#confirm-modal-button").click(()=>{delete state.papers[e],chrome.storage.local.set({papers:state.papers},()=>{state.papersList=Object.values(state.papers),displayMemoryTable(),$("#confirm-modal").remove(),console.log("Successfully deleted '"+t+"' from ArxivMemory")})})},setMemorySortArrow=e=>{let t;t="up"===e?'<svg class="memory-sort-arrow-svg" id="memory-sort-arrow-up">\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-arrow-narrow-up" />\n                </svg>':'<svg class="memory-sort-arrow-svg" id="memory-sort-arrow-down">\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-arrow-narrow-down" />\n                </svg>',$("#memory-sort-arrow").html(t)},openMemory=()=>{state.menuIsOpen&&closeMenu(),$("#tabler-menu").fadeOut(),$("#memory-select").val("lastOpenDate"),setMemorySortArrow("down"),$("#memory-container").slideDown({duration:300,easing:"easeOutQuint",complete:()=>{chrome.storage.local.get("papers",function({papers:e}){console.log("Found papers:"),console.log(e),e=migrateData(e),state.papers=e,state.papersList=Object.values(e),state.sortKey="lastOpenDate",$("#memory-search").attr("placeholder",`Search ${state.papersList.length} entries ...`),state.papersList.length<20?delayTime=0:state.papersList.length<50?delayTime=200:delayTime=350,$("#memory-search").keypress(delay(e=>{const t=$.trim($(e.target).val());t.startsWith("t:")?filterMemoryByTags(t):filterMemoryByString(t),displayMemoryTable()},delayTime)).keyup(e=>{8==e.keyCode&&$("#memory-search").trigger("keypress")}),sortMemory(),makeTags(),displayMemoryTable(),setTimeout(()=>{$("#memory-search").focus()},400)})}}),$("#memory-switch-text-on").fadeOut(()=>{$("#memory-switch-text-off").fadeIn()}),$("#memory-select").change(e=>{const t=$(e.target).val();state.sortKey=t,sortMemory(),displayMemoryTable(),setMemorySortArrow("down")}),$("#memory-sort-arrow").click(e=>{"memory-sort-arrow-down"===$("#memory-sort-arrow svg").first()[0].id?setMemorySortArrow("up"):setMemorySortArrow("down"),reverseMemory(),displayMemoryTable()}),$(document).on("keydown",function(e){if(state.memoryIsOpen)if(13==e.which){const e=$(".memory-item-container:focus").first();if(1!==e.length)return;const t=e.attr("id").replace("memory-item-container-",""),o=state.papers[t].pdfLink;focusExistingOrCreateNewTab(o,t)}else if(8==e.which){const e=$(".memory-item-container:focus").first();if(1!==e.length)return;const t=e.attr("id").replace("memory-item-container-","");confirmDelete(t)}else if(69==e.which){const t=$(".memory-item-container:focus").first();if(1!==t.length)return;e.preventDefault();const o=t.attr("id").replace("memory-item-container-",""),s=o.replace(".","\\.");$(`#memory-item-tag--${s}`).click()}else if(78==e.which){const t=$(".memory-item-container:focus").first();if(1!==t.length)return;e.preventDefault();const o=t.attr("id").replace("memory-item-container-",""),s=o.replace(".","\\.");$(`#memory-item-expand--${s}`).click(),$(`#edit-note-item--${s}`).click(),$(`#form-note-textarea--${s}`).focus()}})},migrateData=e=>{let t=!1;for(const o in e)e[o].hasOwnProperty("tags")&&Array.isArray(e[o].tags)||(e[o].tags=[],console.log("Migrating tags for "+o),t=!0),e[o].hasOwnProperty("note")&&"string"==typeof e[o].note||(e[o].note="",console.log("Migrating note for "+o),t=!0);return t&&chrome.storage.local.set({papers:e},()=>{console.log("Migrated papers:"),console.log(e)}),e},closeMemory=()=>{$("#memory-container").slideUp({duration:500,easing:"easeOutQuint"}),$("#memory-switch-text-off").fadeOut(()=>{$("#memory-switch-text-on").fadeIn()}),$("#tabler-menu").fadeIn()},main=e=>{var t=null,o=!1;const s=()=>{try{clearTimeout(t),$("#feedback-notif").remove(),o=!0}catch(e){console.log("No feedback to remove.")}$("#menuDiv").append('\n            <div id="check-feedback">\n                <svg class="tabler-icon">\n                    <use xlink:href="../../icons/tabler-sprite-nostroke.svg#tabler-floppy-disk" />\n                </svg>\n            </div>\n        '),$("#check-feedback").animate({right:"12px",opacity:"1"},300,"easeInOutBack"),t=setTimeout(()=>{$("#check-feedback").animate({right:"-100px",opacity:"0"},300,"easeInOutBack",()=>{!o&&$("#check-feedback").remove(),o=!1})},1500)},n=parseUrl(e.url);$("#helpGithubLink").click(()=>{chrome.tabs.update({url:"https://github.com/vict0rsch/ArxivTools"})}),$("#coblock").click(()=>{chrome.tabs.update({url:"https://marketplace.visualstudio.com/items?itemName=vict0rsch.coblock"})}),$(document).on("keydown",function(e){if(!state.memoryIsOpen&&13==e.which){const e=$("#memory-switch-text-on:focus").first();if(1!==e.length)return;$("#memory-switch-text-on").click()}}),$("#tabler-menu").click(()=>{state.menuIsOpen?closeMenu():openMenu(),state.menuIsOpen=!state.menuIsOpen}),$("#memory-switch").click(()=>{state.memoryIsOpen?closeMemory():openMemory(),state.memoryIsOpen=!state.memoryIsOpen}),$("#download-arxivmemory").click(()=>{const e=(new Date).toLocaleString();chrome.storage.local.get("papers",({papers:t})=>{downloadTextFile(JSON.stringify(t),`arxiv-memory-${e}.json`,"text/json")})});const a=["checkBib","checkMd","checkDownload","checkPdfTitle","checkVanity","checkMemory"];chrome.storage.local.get(a,function(e){const t={};for(const o of a)t[o]=e.hasOwnProperty(o);const o={};for(const s of a)o[s]=!t[s]||e[s];chrome.storage.local.set(o,function(){chrome.storage.local.get(a,function(e){for(const s of a)$("#"+s).prop("checked",e[s]),o[s]=!t[s]||e[s]})});for(const e of a)$("#"+e).change(function(){const t=this.checked;chrome.storage.local.set({[e]:t},function(){s(),console.log(`Settings saved for ${e} (${t})`)})});if("arxiv.org"===n.hostname&&($("#notArxiv").hide(),$("#notPdf").show(),$("#bibtex-card-content").slideUp(),n.href.endsWith(".pdf"))){$("#notPdf").hide(),$("#isArxiv").show();const e=n.href.split("/").reverse()[0].replace(".pdf",""),t="https://arxiv.org/abs/"+e;$("#goToAbstract").text(e),$("#abstract-card").click(e=>{chrome.tabs.update({url:t}),window.close()}),$.get(`https://export.arxiv.org/api/query?id_list=${e}`).then(e=>{const{bibvars:t,bibtext:o}=parseArxivBibtex(e);$("#abstract-card-title").text(t.title),$("#bibtex-card-content").text(o),$("#bibtex-card-header").click(e=>{copyTextToClipboard($("#bibtex-card-content").text()),$("#bibtex-svg").fadeOut(()=>{$("#clipboard-ok").fadeIn(()=>{setTimeout(()=>{$("#clipboard-ok").fadeOut(()=>{$("#bibtex-svg").fadeIn()})},1500)})})})})}})};$(()=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(e){e[0].url;main(e[0])})});